<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ­¦æ—èŠå¤©å®¤</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --error-color: #ff4444;
        }
        /* ç³»ç»Ÿæ¶ˆæ¯ç‰¹æ®Šæ ·å¼ */
        .system-user-list {
            background: #f8f8f8;
            border-left: 4px solid var(--primary-color);
            padding: 12px 20px;
            margin: 15px 10%;
        }

        .user-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .user-item {
            background: white;
            padding: 4px 12px;
            border-radius: 15px;
            border: 1px solid var(--primary-color);
        }

        .user-item::before {
            content: "âš”ï¸";
            margin-right: 5px;
        }

        body {
            margin: 0;
            height: 100vh;
            display: grid;
            grid-template-columns: 200px 1fr;
            font-family: 'æ¥·ä½“', cursive;
            background: #f0f0f0;
        }

        /* å¥½å‹åˆ—è¡¨ */
        .friends-list {
            background: white;
            padding: 1rem;
            border-right: 2px solid #ddd;
            overflow-y: auto;
        }

        .friend-item {
            padding: 1rem;
            margin: 0.5rem 0;
            background: #f8f8f8;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .friend-item:hover {
            background: var(--primary-color);
            color: white;
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #messageContainer {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: url('https://example.com/chat-bg.jpg');
            min-height: 300px; /* é˜²æ­¢ç©ºç™½ */
        }

        /* æ¶ˆæ¯æ°”æ³¡ */
        .message-bubble {
            max-width: 60%;
            margin: 1rem;
            padding: 1rem;
            border-radius: 12px;
            position: relative;
        }

        .received-message {
            background: white;
            border: 2px solid var(--primary-color);
            margin-right: auto;
        }

        .sent-message {
            background: var(--primary-color);
            color: white;
            margin-left: auto;
        }

        .system-message {
            background: #f8f8f8;
            color: #666;
            text-align: center;
            margin: 1rem auto;
            width: 80%;
            padding: 0.5rem;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 1rem;
            background: white;
            border-top: 2px solid #ddd;
            display: flex;
            gap: 1rem;
        }

        #messageInput {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            font-size: 1.1rem;
        }

        #sendBtn {
            background: var(--primary-color);
            color: white;
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #sendBtn:hover {
            background: #45a049;
        }

        #connectionStatus {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: var(--primary-color);
            color: white;
        }
    </style>
</head>
<body>
<div class="friends-list">
    <h3>æ±Ÿæ¹–å¥½å‹</h3>
    <div id="friendsContainer">
        <!-- å¥½å‹åˆ—è¡¨ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>

<div class="chat-container">
    <div id="messageContainer"></div>
    <div class="input-area">
        <input type="text" id="messageInput" placeholder="è¾“å…¥æ­¦æ—å¯†è¯­...">
        <button id="sendBtn" onclick="sendMessage()">å‘é€</button>
    </div>
    <div id="connectionStatus">è¿æ¥ä¸­...</div>
</div>

<script>
    // å…¨å±€çŠ¶æ€ç®¡ç†
    let ws = null;
    const currentUser = sessionStorage.getItem('currentUser');
    const friend = currentUser === 'èµµæ•' ? 'å¼ æ— å¿Œ' : 'èµµæ•';

    // åˆå§‹åŒ–WebSocketè¿æ¥
    function initWebSocket() {
        ws = new WebSocket(`ws://${window.location.host}/chat`);

        // è¿æ¥äº‹ä»¶ç›‘å¬
        ws.onopen = () => {
            console.log('WebSocketè¿æ¥å·²å»ºç«‹');
            document.getElementById('connectionStatus').style.backgroundColor = '#4CAF50';
            document.getElementById('connectionStatus').textContent = 'å·²è¿æ¥';
            addSystemMessage('å·²è¿›å…¥æ±Ÿæ¹–èŠå¤©å®¤');
        };

        ws.onmessage = (event) => {
            console.log('æ”¶åˆ°åŸå§‹æ¶ˆæ¯:', event.data);
            try {
                const msg = safeParseMessage(event.data);
                if (msg.system) {
                    addSystemMessage(msg.message);
                } else {
                    addReceivedMessage(msg);
                }
            } catch (error) {
                console.error('æ¶ˆæ¯å¤„ç†å¤±è´¥:', error);
                addSystemMessage(`æ”¶åˆ°æ— æ³•è¯†åˆ«çš„æ¶ˆæ¯: ${escapeHtml(event.data)}`);
            }
        };

        ws.onerror = (error) => {
            console.error('è¿æ¥é”™è¯¯:', error);
            document.getElementById('connectionStatus').style.backgroundColor = '#ff4444';
            document.getElementById('connectionStatus').textContent = 'è¿æ¥é”™è¯¯';
        };

        ws.onclose = (event) => {
            console.log('è¿æ¥å…³é—­:', event.code, event.reason);
            document.getElementById('connectionStatus').style.backgroundColor = '#666';
            document.getElementById('connectionStatus').textContent = 'è¿æ¥å·²å…³é—­';
            setTimeout(initWebSocket, 3000); // 3ç§’åé‡è¿
        };
    }

    // å¢å¼ºç‰ˆæ¶ˆæ¯è§£æ
    function safeParseMessage(data) {
        try {
            const rawMsg = JSON.parse(data);

            // é€‚é…å›¾ç‰‡ä¸­çš„éå¸¸è§„JSONæ ¼å¼
            const isSystem = String(rawMsg.system).toLowerCase() === "true";
            const messageContent = Array.isArray(rawMsg.message)
                ? rawMsg.message
                : [rawMsg.message];

            return {
                system: isSystem,
                from: rawMsg.fromName || null,
                message: messageContent
            };
        } catch (e) {
            throw new Error('æ¶ˆæ¯è§£æå¤±è´¥: ' + e.message);
        }
    }

    // ä¿®æ”¹åçš„ç³»ç»Ÿæ¶ˆæ¯æ¸²æŸ“
    function addSystemMessage(content) {
        const container = document.getElementById('messageContainer');
        const div = document.createElement('div');

        if (Array.isArray(content)) {
            // å¤„ç†ç”¨æˆ·åˆ—è¡¨æ¶ˆæ¯
            div.className = 'system-user-list';
            div.innerHTML = `
                    <div class="system-header">ğŸ® å½“å‰åœ¨çº¿è±ªæ°</div>
                    <div class="user-list">
                        ${content.map(user => `
                            <div class="user-item">${escapeHtml(user)}</div>
                        `).join('')}
                    </div>
                `;
        } else {
            // æ™®é€šç³»ç»Ÿæ¶ˆæ¯
            div.className = 'system-message';
            div.innerHTML = `
                    <svg style="width:16px;height:16px;vertical-align:-2px" viewBox="0 0 24 24">
                        <path fill="${escapeHtml(content).includes('è¿›å…¥') ? '#4CAF50' : '#ff4444'}"
                              d="M11,9H13V7H11M12,20C8.13,20 5,16.87 5,13C5,11.07 5.78,9.32 7.05,8.05L8.46,9.46C7.61,10.31 7,11.5 7,13C7,15.76 9.24,18 12,18C14.76,18 17,15.76 17,13C17,11.5 16.39,10.31 15.54,9.46L16.95,8.05C18.22,9.32 19,11.07 19,13C19,16.87 15.87,20 12,20M11,15H13V11H11M12,4C14.12,4 16,5.88 16,8C16,10.12 14.12,12 12,12C9.88,12 8,10.12 8,8C8,5.88 9.88,4 12,4Z"/>
                    </svg>
                    ${escapeHtml(content)}
                `;
        }

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }
    function addReceivedMessage(msg) {
        const container = document.getElementById('messageContainer');
        const div = document.createElement('div');
        div.className = 'message-bubble received-message';
        div.innerHTML = `
                <div class="message-header">${escapeHtml(msg.from)}</div>
                <div class="message-content">${escapeHtml(msg.message)}</div>
            `;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function addSentMessage(content) {
        const container = document.getElementById('messageContainer');
        const div = document.createElement('div');
        div.className = 'message-bubble sent-message';
        div.innerHTML = `
                <div class="message-header">æˆ‘</div>
                <div class="message-content">${escapeHtml(content)}</div>
            `;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    // æ¶ˆæ¯å‘é€
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const content = input.value.trim();

        if (!content) {
            alert('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
            return;
        }

        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert('è¿æ¥æœªå°±ç»ªï¼Œè¯·ç¨åå†è¯•ï¼');
            return;
        }

        const message = {
            system: false,
            from: currentUser,
            message: content,
            to: friend,
            timestamp: Date.now()
        };

        try {
            ws.send(JSON.stringify(message));
            addSentMessage(content);
            input.value = '';
        } catch (error) {
            console.error('å‘é€å¤±è´¥:', error);
            alert('æ¶ˆæ¯å‘é€å¤±è´¥ï¼');
        }
    }

    // XSSé˜²æŠ¤
    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // åˆå§‹åŒ–
    if (!currentUser) {
        alert('è¯·å…ˆç™»å½•ï¼');
        window.location.href = 'login.html';
    } else {
        // åˆå§‹åŒ–å¥½å‹åˆ—è¡¨
        document.getElementById('friendsContainer').innerHTML = `
                <div class="friend-item">${friend}</div>
            `;
        // å¯åŠ¨WebSocket
        initWebSocket();

        // å›è½¦å‘é€æ”¯æŒ
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    }
</script>
</body>
</html>